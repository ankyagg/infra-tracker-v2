<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Issue | CivicGuard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%2300d4d4' d='M256 0c4.6 0 9.2 1 13.4 2.9L457.8 82.8c22 9.3 38.4 31 38.3 57.2-.5 99.2-41.3 280.7-213.6 363.2-16.7 8-36.1 8-52.8 0-172.4-82.5-213.1-264-213.6-363.2-.1-26.2 16.3-47.9 38.3-57.2L242.7 2.9C246.9 1 251.4 0 256 0zm0 66.8l0 378.1c138-66.8 175.1-214.8 176-303.4l-176-74.6 0 0z'/%3E%3C/svg%3E">
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="nav-logo" style="font-size: 1rem;">
      <i class="fa-solid fa-chevron-left" style="color:var(--accent-cyan);"></i> &nbsp; Back to Home
    </a>
    <div style="display: flex; align-items: center; gap: 15px;">
      <span id="userGreeting" style="font-weight: 500; color: var(--text-light); font-size: 0.9rem;"></span>
      <button id="logoutBtn" onclick="logout()" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #fca5a5; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </button>
    </div>
  </nav>

  <main class="app-container">
    <section class="app-card" id="formSection">
      <h2 style="margin-top:0; color:var(--navy-primary);"><i class="fa-solid fa-camera"></i> New Incident Report</h2>
      
      <form id="reportForm">
        <label>Issue Category</label>
        <select required>
          <option value="">-- Select Type --</option>
          <option>Road Damage / Pothole</option>
          <option>Broken Streetlight</option>
          <option>Open Manhole</option>
          <option>Water Leakage</option>
          <option>Garbage Dump</option>
        </select>

        <label>Capture Evidence (Photo)</label>
        <div class="file-upload-wrapper">
          <input type="file" id="fileInput" accept="image/*" capture="environment" required>
          <div class="file-upload-visual" id="fileVisual">
            <i class="fa-solid fa-camera" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <span id="fileText">Tap to Capture Photo</span>
          </div>
        </div>

        <label>Description</label>
        <textarea rows="3" placeholder="Describe the severity..."></textarea>

        <label>Location</label>
        <div style="display:flex; gap:10px;">
          <input type="text" id="locationInput" placeholder="GPS Coordinates" readonly>
          <button type="button" id="getLocationBtn" style="width:auto; height:45px; padding:0 25px; background:var(--navy-light); border:none; color:white; border-radius: 8px; cursor:pointer;">
            <i class="fa-solid fa-location-crosshairs"></i>
          </button>
        </div>

        <button type="submit" class="analyze-btn">Analyze Risk</button>
      </form>
    </section>

    <div id="riskResultContainer"></div>
  </main>
  
  <script>
    // Check if user is logged in and show logout button
    function checkUserLogin() {
      const token = localStorage.getItem('userToken');
      const userName = localStorage.getItem('userName');
      
      if (token && userName) {
        document.getElementById('userGreeting').textContent = `Hi, ${userName}`;
        document.getElementById('logoutBtn').style.display = 'inline-flex';
      }
    }
    
    async function logout() {
      const token = localStorage.getItem('userToken');
      
      try {
        await fetch('/auth/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
      } catch (err) {
        console.error('Logout error:', err);
      }
      
      // Clear all auth data
      localStorage.removeItem('userToken');
      localStorage.removeItem('userName');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userRole');
      
      // Redirect to home
      window.location.href = 'index.html';
    }
    
    // Check login on page load
    checkUserLogin();
  </script>
  <script src="script.js"></script>
</body>
</html>